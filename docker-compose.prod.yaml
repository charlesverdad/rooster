# Production overlay: proxy with landing page (no cloudflared tunnel)
#
# Usage:
#   docker compose -f docker-compose.yaml -f docker-compose.prod.yaml up --build -d
#
# The proxy runs on port 8080 (configurable via PROXY_PORT).
# Put a reverse proxy (Caddy, Traefik, nginx) in front for HTTPS.
#
# Required .env settings for production:
#   SECRET_KEY=<random-secret>          # python -c "import secrets; print(secrets.token_urlsafe(32))"
#   POSTGRES_PASSWORD=<strong-password>
#   APP_URL=https://yourdomain.com      # For invite email links
#   CORS_ORIGINS=https://yourdomain.com
#   EMAIL_ENABLED=true
#   VAPID_PUBLIC_KEY=<key>
#   VAPID_PRIVATE_KEY=<key>
#   VAPID_SUBJECT=mailto:you@yourdomain.com

services:
  # Override frontend to use relative API URL (works behind proxy)
  frontend:
    build:
      context: ./frontend
      args:
        API_BASE_URL: /api

  # Reverse proxy: landing page + frontend + API behind a single origin
  proxy:
    image: nginx:alpine
    volumes:
      - ./tunnel/proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./landing:/usr/share/nginx/landing:ro
    ports:
      - "${PROXY_PORT:-8080}:80"
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

  # Production overrides for other services
  backend:
    restart: unless-stopped

  db:
    restart: unless-stopped
